#!/usr/bin/env perl

use strict;
use warnings;

use Test::More qw(no_plan); # for the is() and isnt() functions
use IPC::Run qw(run);
use FindBin;
my $testee = "$FindBin::Bin/rk";

sub get_meta() {
    my ($file) = @_;

    my $dump=`getfattr -d '$file'`;

    open my $fh, '<', \$dump;

    my %fields;
    while (<$fh>) {
        next unless m/^[\s]*user.rk.(md5|htime|state|vtime)="(.*)"[\s]*$/;
        $fields{$1} = $2;
    }

    return %fields;
}

sub invoke {
	my ($file, $mode) = @_;
	run [ $testee, "-$mode", $file ], ">", \my $out or die;
	return $out;
}

sub clobber_file {
	my ($file, $content) = @_;
    system("echo -n '$content' > '$file'");	
}

# TODO:
# -l    Default: Print some status line
# -v    Verify metadata where it exists
# -a    Combination -n & -v
# -x    Delete all metadata. - THIS NEEDS RETESTING WITH ALL 4 KEYS!
# -e    (export)

my $fs = shift;

&test_nx($fs.'/1 - name with a space.testfile');
&test_nv($fs.'/2 - name with a space.testfile');
&test_a ($fs.'/3 - name with a space.testfile');
&test_e ($fs.'/4 - name with a space.testfile');

sub test_nx() {
	my ($file) = @_;

	############################################################################
	## Constants/variables

	my $v1 = 'abcdefghijklmnopqrstuvwxyz';
	my $v2 = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
	my $v3 = '0123456789';

	my $h1 = 'c3fcd3d76192e4007dfb496cca67e13b';
	my $h2 = '437bba8e0bf58337674f4539e75186ac';
	my $h3 = '781e5e245d69b566979b86e28d23f2c7';

	my %meta;
	my $last_htime;

	############################################################################
	## Test body

	&clobber_file($file, $v1);

	%meta = &get_meta($file);
	&is(scalar keys %meta,0);

	&is(&invoke($file, 'n'), "? $file\n");
	%meta = &get_meta($file);
	&is(scalar keys %meta,2);
	&is($meta{md5},$h1);
	&is(length($meta{htime}),19); # TODO FORMAT CHECK

	$last_htime = $meta{htime};

	&clobber_file($file, $v2);

	sleep(1);
	&is(&invoke($file, 'x'), "  $file\n");
	%meta = &get_meta($file);
	&is(scalar keys %meta,0);

    unlink $file;
}

sub test_nv() {
	my ($file) = @_;

	############################################################################
	## Constants/variables

	my $v1 = 'abcdefghijklmnopqrstuvwxyz';
	my $v2 = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';

	my $h1 = 'c3fcd3d76192e4007dfb496cca67e13b';

	my %meta;

	############################################################################
	## Test body

	&clobber_file($file, $v1);

	%meta = &get_meta($file);
	&is(scalar keys %meta,0);

	&is(&invoke($file, 'v'), "  $file\n");
	%meta = &get_meta($file);
	&is(scalar keys %meta,0);

	&is(&invoke($file, 'n'), "? $file\n");
	%meta = &get_meta($file);
	&is(scalar keys %meta,2);
	&is($meta{md5},$h1);
	&is(length($meta{htime}),19); # TODO FORMAT CHECK

	my $htime = $meta{htime};

	sleep(1);
	&is(&invoke($file, 'v'), "V $file\n");
	%meta = &get_meta($file);
	&is(scalar keys %meta,4);
	&is($meta{md5},$h1);
	&is($meta{htime},$htime); # TODO FORMAT CHECK
	&is($meta{state},'V');
	&ok($meta{vtime} gt $meta{htime}); # TODO FORMAT CHECK

	my $last_vtime = $meta{vtime};

	&clobber_file($file, $v2);

	sleep(1);
	&is(&invoke($file, 'v'), "X $file\n");
	%meta = &get_meta($file);
	&is(scalar keys %meta,4);
	&is($meta{md5},$h1);
	&is($meta{htime},$htime); # TODO FORMAT CHECK
	&is($meta{state},'X');
	&ok($meta{vtime} eq $last_vtime); # TODO FORMAT CHECK

    unlink $file;
}

sub test_a() {
	my ($file1) = @_;
	my $file2 = "$file1.b";
	$file1 .= ".a";

	############################################################################
	## Constants/variables

	my $v1 = 'abcdefghijklmnopqrstuvwxyz';
	my $v2 = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
	my $v3 = '0123456789';

	my $h1 = 'c3fcd3d76192e4007dfb496cca67e13b';
	my $h2 = '437bba8e0bf58337674f4539e75186ac';

	my %meta;

	############################################################################
	## Test body

	&clobber_file($file1, $v1);

	%meta = &get_meta($file1);
	&is(scalar keys %meta,0);

	&is(&invoke($file1, 'a'), "? $file1\n");
	%meta = &get_meta($file1);
	&is(scalar keys %meta,2);
	&is($meta{md5},$h1);
	&is(length($meta{htime}),19); # TODO FORMAT CHECK

	my $htime = $meta{htime};

	&clobber_file($file1, $v3);
	&clobber_file($file2, $v2);

	%meta = &get_meta($file2);
	&is(scalar keys %meta,0);

	sleep(1);
	&is(
		&invoke($file1, 'a') . &invoke($file2, 'a'), # TODO one call
		"X $file1\n? $file2\n");
	%meta = &get_meta($file1);
	&is(scalar keys %meta,3);
	&is($meta{md5},$h1);
	&is($meta{htime},$htime); # TODO FORMAT CHECK
	&is($meta{state},'X');
	%meta = &get_meta($file2);
	&is(scalar keys %meta,2);
	&is($meta{md5},$h2);
	&ok($meta{htime} gt $htime); # TODO FORMAT CHECK

    unlink $file1, $file2;
}

sub test_e {
	my ($file) = @_;

	############################################################################
	## Constants/variables

	my $v1 = 'abcdefghijklmnopqrstuvwxyz';
	my $h1 = 'c3fcd3d76192e4007dfb496cca67e13b';

	my %meta;

	############################################################################
	## Test body

	&clobber_file($file, $v1);

	%meta = &get_meta($file);
	&is(scalar keys %meta,0);

	&is(&invoke($file, 'e'), "        26  ????????????????????????????????  $file\n");
	%meta = &get_meta($file);
	&is(scalar keys %meta,0);

	&is(&invoke($file, 'a'), "? $file\n");
	%meta = &get_meta($file);
	&is(scalar keys %meta,2);
	&is($meta{md5},$h1);
	&is(length($meta{htime}),19); # TODO FORMAT CHECK

	&is(&invoke($file, 'e'), "        26  $h1  $file\n");
	%meta = &get_meta($file);
	&is(scalar keys %meta,2);
	&is($meta{md5},$h1);
	&is(length($meta{htime}),19); # TODO FORMAT CHECK

    unlink $file;
}